#!/bin/bash

# esporta le variabili d'ambiente
set -a

# constants
DATA_DIR="data"
SUGGERIMENTI_DIR="suggerimenti"
LITURGIA_URL="https://www.chiesacattolica.it/liturgia-del-giorno/?data-liturgia="
LITURGIA_DIR="liturgie"
LITURGIA_FILE_BASENAME="liturgia"
SUGGERIMENTI_FILE_BASENAME="suggerimenti"


# importing functions
source ./scripts/get_anagrafica
source ./scripts/get_next_sunday
source ./scripts/get_liturgia

# crea cartella data se non esiste
if [ ! -d "$DATA_DIR" ]; then
  mkdir $DATA_DIR
fi

# crea cartella suggerimenti se non esiste
if [ ! -d "$SUGGERIMENTI_DIR" ]; then
  mkdir $SUGGERIMENTI_DIR
fi

# crea cartella liturgie se non esiste
if [ ! -d "$LITURGIA_DIR" ]; then
  mkdir $LITURGIA_DIR
fi

# rendi eseguibili gli script
chmod +x ./scripts/*

# scarica anagrafica
# get_anagrafica > $DATA_DIR/anagrafica_canti.csv
# echo "âœ… Scaricata anagrafica canti"

# scarica testi
# ./scripts/db_downloader
# echo "âœ… Scaricati testi canti"

# scarica liturgia
LITURGIA_DATE=$(get_next_sunday)

get_liturgia $LITURGIA_DATE > $LITURGIA_DIR/$LITURGIA_FILE_BASENAME-$LITURGIA_DATE.txt
cp $LITURGIA_DIR/$LITURGIA_FILE_BASENAME-$LITURGIA_DATE.txt $LITURGIA_DIR/$LITURGIA_FILE_BASENAME-latest.txt

LITURGIA_DATE=$(date -d $LITURGIA_DATE +%d/%m/%Y)
echo "ðŸ“… Data della prossima liturgia domenicale: $LITURGIA_DATE"
echo "âœ… Scaricata liturgia"

# run suggeritore
./scripts/suggeritore.py

# organize files (suggerimenti md e csv)
mv $SUGGERIMENTI_FILE_BASENAME.md $SUGGERIMENTI_DIR/$SUGGERIMENTI_FILE_BASENAME-latest.md
cp $SUGGERIMENTI_DIR/$SUGGERIMENTI_FILE_BASENAME-latest.md $SUGGERIMENTI_DIR/$SUGGERIMENTI_FILE_BASENAME-$(date +%Y%m%d).md
cp $DATA_DIR/$SUGGERIMENTI_FILE_BASENAME-latest.csv $DATA_DIR/$SUGGERIMENTI_FILE_BASENAME-$(date +%Y%m%d).csv

echo "âœ… Suggerimenti pronti"
echo "ðŸ“‚ Suggerimenti disponibili in $SUGGERIMENTI_DIR"